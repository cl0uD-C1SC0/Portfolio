#
# 
#

4 = VERSÃO 1
5 = VERSÃO 2

# No STEP 2 não sei se é para mudar a versão do PROD para 2 ou manter a mesma.

STEP 1:

- Abra o AWS Lambda Console
- Selecione a função lambda: GreetingLambda
- Replace greeting string de "Hello" para "Hi" no código fonte
- Deploy, e espere pelo Deploy completo.
- Clique em Test
    * Se você usar "Hello World" test event como referencia:
        Event Name: (GreetingTestEvent)
        Event Template Json: {"name": "awsstudent"} (delete the default template)
        Clique em create e test.

(ESSE STEP É MUITO PERIGOSO, PORTANTO CUIDADO!)
STEP 2:

- No Lambda Console, clique em versões
- Publique uma nova versão
- Descrição "version 2"
- Volte para a função Lambda do STEP 1 e note que tem várias versões da sua função Lambda
- Note dois alises Lambda (staging and pro) referente a versão 1
- Mude o staging alias para versão 2 (staging alias to point to version 2)
- Volte para a função lambda na página principal.
- Clique em Aliases
    - Selecione staging alias clicando no correspondente radio button e clique em Edit
    - Atualiza a versão do Lambda no staging alias para versão 2 e clique em Salvar.
    - Agora clique no alias name (should be a clickable link)
    - Clique em Test para rodar a função Lambda
    - Expanda o execution logs e depois clique em detalhes.
    - Agora faça o mesmo procedimento clicando em prod alias (Verifique se o output produzido é diferente)
        Output prod alis: {"greeting": "Hello, awsstudent!"}

STEP 3:
-  Navegue até o console do API Gateway
- Selecione API de greeting
- Clique no rótulo do método "GET" em "/greetings" Função API.
- Clique em "Solicitação de Integração" (Integration Request algo assim)
- Parametro Lambda Function. 
- No campo Função do Lambda (Lambda Function) digite (Diversas Opções):
    1- GreetingLambda: $ {StageVariables.Environment}
    2- "GreetingLambda: $ {StageVariables.Environment}"
    3- GreetingLambda:${stageVariables.environment}
    4- GreetingLambda:${StageVariables.Environment}
    5- "GreetingLambda:${StageVariables.Environment}"
    6- "GreetingLambda:${StageVariables.Environment}"

- Salve a alteração e reimplante a API em cada estágio clidando no rótulo da API de greeting
    - Actions
    - Implantar API (Implant API algo assim)
    - Escolha "test" API, e em seguida repita o processo para o estágio de API "prod"
    - Acerte seus endpoints de API de produção e preparação mais uma vez a partir do seu navegador
    - Você verá resultados diferentes agora! 
    - Use seu navegador para abrir a URL indicada pelo output parameter (CheckChallengeAnswerUrl)

OBS:
    Como dar a permissão de Lambda:InvokeFunction sem CLI:
        Vá no ALIAS EX: prod
        Em Permissions, scroll down até Resource-based-policy
        Crie um novo Resource-based-policy:
            -> AWS Service
            Service: (Se precisar coloque API Gateway)
            Statement ID: Qualquer um
            Principal: apigateway.amazonaws.com
            Source ARN: arn:aws:execute-api:us-east-1:accountid:idapigateway/*/*/GreetingLambda
            Action: Lambda:InvokeFunction

        VALUES:
            accountdID = Account ID
            idapigateway:
                - Va no API Gateway que o Lambda usa
                - Selecione Resources 
                - Selecione o Metodo (GET)
                - Procure pelo Method Request e o ARN
                - Procure um valor entre : e /
                EX: n9bbm9iw0m
                EX2:  arn:aws:execute-api:us-east-1:200733096250:>>>n9bbm9iw0m<<<</*/GET/greetings

OBS:
    NO STEP 3 TALVEZ TENHA QUE VALIDAR A FUNÇÃO APLICANDO UMA REGRA NA CLI:

    aws lambda add-permission --function-name <"arn:aws:lambda:us-east-1:accountid:function:GreetingLambda:staging/prod>"
    --source-arn <"arn:aws:execute-api:us-east-1:200733096250:n9bbm9iw0m/*/GET/greetings">
    --principal apigateway.amazonaws.com   --statement-id <fce9ba44-7e9b-458f-9a23-92fa72be750e>   --action lambda:InvokeFunction --region <us-east-1>

    OBS: Os valores ente <> poderam ser diferentes!!!
    OBS: Para validar a task pode ser que só tenha que dar um uplaod na nova versão prod!
    OBS: Provalvemente haveram dois / de API CALL (Prod and Staging), os dois retornam o mesmo valor do Lambda alias PROD.
    Provavelmente teremos que alterar somente o valor do Staging. Colocando o GreetingLambda:${stageVariables.environment} e no STAGE (no console de API TAB)
    clicamos em Staging e em Stage Variables criamos uma variavel: environment = staging