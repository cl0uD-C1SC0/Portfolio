Access Previews:

CREATING ACCESS PREVIEWS WITH CLI:

sudo yum install jq -y
aws accessanalyzer create-analyzer --type ACCOUNT --analyzer-name AccessAnalyzerCICDWorkshop
ANALYZER_ARN=$(aws accessanalyzer list-analyzers --query "analyzers[?status=='ACTIVE' && type=='ACCOUNT'].arn | [0]" --output text)    
echo $ANALYZER_ARN
ACCOUNT_ID=$(aws sts get-caller-identity --query 'Account' --output text)
cat << EOF > iam-access-analyzer/queue-policy.json
{
    "Version": "2012-10-17",
    "Id": "MyQueuePolicy",
    "Statement": [{
        "Sid":"AllowSendMessage",
        "Effect": "Allow",
        "Principal": {
            "AWS": "111122223333"
        },
        "Action": "sqs:SendMessage",
        "Resource": "arn:aws:sqs:us-east-1:${ACCOUNT_ID}:MyQueue"
    }]
}
EOF

OBS: Essa politica é um exemplo de política para Access Viewers

QUEUE_POLICY=$(cat iam-access-analyzer/queue-policy.json | jq -c .)
# Load the configuration json into a variable
CONFIGURATIONS=$(jq -n -c --arg account_id "$ACCOUNT_ID" --arg queue_policy "$QUEUE_POLICY" '{"arn:aws:sqs:us-east-1:\($account_id):MyQueue": {sqsQueue: {queuePolicy: $queue_policy}}}')
# Execute accessanalyzer create-access-preview
PREVIEW_ID=$(aws accessanalyzer create-access-preview --configurations $CONFIGURATIONS --analyzer-arn $ANALYZER_ARN --output text)
echo $PREVIEW_ID

aws accessanalyzer get-access-preview --analyzer-arn $ANALYZER_ARN  --access-preview-id $PREVIEW_ID
aws accessanalyzer list-access-preview-findings --analyzer-arn $ANALYZER_ARN --access-preview-id $PREVIEW_ID  





