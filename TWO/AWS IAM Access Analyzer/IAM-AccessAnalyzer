EXEMPLE DE ANALYSIS:

mkdir iam-access-analyzer
cat << EOF > iam-access-analyzer/identity-policy.json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "ec2:RunInstance"
            ],
            "Resource": "arn:aws:ec2:*:*:instance/my-custom-instance"
        }
    ]
}
EOF


aws accessanalyzer validate-policy --policy-type IDENTITY_POLICY --policy-document file://iam-access-analyzer/identity-policy.json

VALIDING SCP POLICIES;
EXAMPLE POLICY SCP:
cat << EOF > iam-access-analyzer/scp.json
{
    "Version": "2012-10-17",
    "Statement": [{
        "Principal": "*",
        "Effect": "Deny",
        "Action": [
            "ec2:CreateInternetGateway"
        ],
        "Resource": "*"
    }]
}
EOF


aws accessanalyzer validate-policy --policy-type SERVICE_CONTROL_POLICY --policy-document file://iam-access-analyzer/scp.json

CREATE AN ANALYZER IN OUR ACCOUNT:
aws accessanalyzer create-analyzer --type ACCOUNT --analyzer-name AccessAnalyzerCICDWorkshop
ANALYZER_ARN=$(aws accessanalyzer list-analyzers --query "analyzers[?status=='ACTIVE' && type=='ACCOUNT'].arn | [0]" --output text)    

echo $ANALYZER_ARN

ACCOUNT_ID=$(aws sts get-caller-identity --query 'Account' --output text)
cat << EOF > iam-access-analyzer/queue-policy.json
{
    "Version": "2012-10-17",
    "Id": "MyQueuePolicy",
    "Statement": [{
        "Sid":"AllowSendMessage",
        "Effect": "Allow",
        "Principal": {
            "AWS": "111122223333"
        },
        "Action": "sqs:SendMessage",
        "Resource": "arn:aws:sqs:us-east-1:${ACCOUNT_ID}:MyQueue"
    }]
}
EOF

QUEUE_POLICY=$(cat iam-access-analyzer/queue-policy.json | jq -c .)
# Load the configuration json into a variable
CONFIGURATIONS=$(jq -n -c --arg account_id "$ACCOUNT_ID" --arg queue_policy "$QUEUE_POLICY" '{"arn:aws:sqs:us-east-1:\($account_id):MyQueue": {sqsQueue: {queuePolicy: $queue_policy}}}')
# Execute accessanalyzer create-access-preview
PREVIEW_ID=$(aws accessanalyzer create-access-preview --configurations $CONFIGURATIONS --analyzer-arn $ANALYZER_ARN --output text)

echo $PREVIEW_ID

#Using the PREVIEW_ID returned from create-access-preview, run the get-access-preview command to track the progress of your access preview. Run this command until you see "status": "COMPLETED" in the response
aws accessanalyzer get-access-preview --analyzer-arn $ANALYZER_ARN  --access-preview-id $PREVIEW_ID

#Once your access preview has completed, list the access preview findings. Run the list-access-preview-findings command to view the findings for your queue policy.
aws accessanalyzer list-access-preview-findings --analyzer-arn $ANALYZER_ARN --access-preview-id $PREVIEW_ID  



